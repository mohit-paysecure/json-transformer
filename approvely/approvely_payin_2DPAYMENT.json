[
  {
    "requestMapping": {
      "method": "POST",
      "url": {
        "mappings": [
          {
            "value": "https://api-sandbox.coinflow.cash/api/tokenize",
            "required": true
          }
        ],
        "operations": [
          {
            "name": "LIST_VALUE_JOIN"
          }
        ]
      },
      "headers": {
        "mappings": [
          {
            "key": "Content-Type",
            "value": "application/json",
            "required": true
          },
          {
            "key": "Accept",
            "value": "application/json",
            "required": true
          },
          {
            "key": "Authorization",
            "mappings": [
              {
                "value": "{{bankTransaction.usedAuthKey}}",
                "required": true,
                "operations": [
                  {
                    "name": "SPLIT_STRING",
                    "params": {
                      "delimiter": "##"
                    }
                  },
                  {
                    "name": "GET_ELEMENT_AT_INDEX",
                    "params": {
                      "index": 0
                    }
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "LIST_VALUE_JOIN"
              }
            ],
            "required": true
          },
          {
            "key": "tx-apikey",
            "mappings": [
              {
                "value": "{{bankTransaction.usedAuthKey}}",
                "required": true,
                "operations": [
                  {
                    "name": "SPLIT_STRING",
                    "params": {
                      "delimiter": "##"
                    }
                  },
                  {
                    "name": "GET_ELEMENT_AT_INDEX",
                    "params": {
                      "index": 1
                    }
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "LIST_VALUE_JOIN"
              }
            ],
            "required": true
          },
          {
            "key": "tx-token-scheme",
            "mappings": [
              {
                "value": "{{bankTransaction.usedAuthKey}}",
                "required": true,
                "operations": [
                  {
                    "name": "SPLIT_STRING",
                    "params": {
                      "delimiter": "##"
                    }
                  },
                  {
                    "name": "GET_ELEMENT_AT_INDEX",
                    "params": {
                      "index": 2
                    }
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "LIST_VALUE_JOIN"
              }
            ],
            "required": true
          },
          {
            "key": "tx-tokenex-id",
            "mappings": [
              {
                "value": "{{bankTransaction.usedAuthKey}}",
                "required": true,
                "operations": [
                  {
                    "name": "SPLIT_STRING",
                    "params": {
                      "delimiter": "##"
                    }
                  },
                  {
                    "name": "GET_ELEMENT_AT_INDEX",
                    "params": {
                      "index": 3
                    }
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "LIST_VALUE_JOIN"
              }
            ],
            "required": true
          }
        ],
        "operations": [
          {
            "name": "KEY_VALUE_LIST_TO_OBJECT"
          }
        ]
      },
      "body": {
        "mappings": [
          {
            "key": "data",
            "value": "{{cardInfo.number}}",
            "required": true
          },
          {
            "key": "cvv",
            "value": "{{cardInfo.cvc}}",
            "required": true
          }
        ],
        "operations": [
          {
            "name": "KEY_VALUE_LIST_TO_OBJECT"
          }
        ]
      }
    },
    "responseMapping": {
      "body": {
        "mappings": [
          {
            "key": "status",
            "value": "payment_in_process"
          },
          {
            "key": "code",
            "value": "success"
          }
        ],
        "operations": [
          {
            "name": "KEY_VALUE_LIST_TO_OBJECT"
          }
        ]
      }
    }
  },
  {
    "requestMapping": {
      "method": "POST",
      "url": {
        "mappings": [
          {
            "value": "{{pspResponseHeader0.location}}",
            "required": true
          }
        ],
        "operations": [
          {
            "name": "LIST_VALUE_JOIN"
          }
        ]
      },
      "headers": {
        "mappings": [
          {
            "key": "Content-Type",
            "value": "application/json",
            "required": true
          },
          {
            "key": "Accept",
            "value": "application/json",
            "required": true
          },
          {
            "key": "Authorization",
            "mappings": [
              {
                "value": "{{bankTransaction.usedAuthKey}}",
                "required": true,
                "operations": [
                  {
                    "name": "SPLIT_STRING",
                    "params": {
                      "delimiter": "##"
                    }
                  },
                  {
                    "name": "GET_ELEMENT_AT_INDEX",
                    "params": {
                      "index": 0
                    }
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "LIST_VALUE_JOIN"
              }
            ],
            "required": true
          },
          {
            "key": "tx-apikey",
            "mappings": [
              {
                "value": "{{bankTransaction.usedAuthKey}}",
                "required": true,
                "operations": [
                  {
                    "name": "SPLIT_STRING",
                    "params": {
                      "delimiter": "##"
                    }
                  },
                  {
                    "name": "GET_ELEMENT_AT_INDEX",
                    "params": {
                      "index": 1
                    }
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "LIST_VALUE_JOIN"
              }
            ],
            "required": true
          },
          {
            "key": "tx-token-scheme",
            "mappings": [
              {
                "value": "{{bankTransaction.usedAuthKey}}",
                "required": true,
                "operations": [
                  {
                    "name": "SPLIT_STRING",
                    "params": {
                      "delimiter": "##"
                    }
                  },
                  {
                    "name": "GET_ELEMENT_AT_INDEX",
                    "params": {
                      "index": 2
                    }
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "LIST_VALUE_JOIN"
              }
            ],
            "required": true
          },
          {
            "key": "tx-tokenex-id",
            "mappings": [
              {
                "value": "{{bankTransaction.usedAuthKey}}",
                "required": true,
                "operations": [
                  {
                    "name": "SPLIT_STRING",
                    "params": {
                      "delimiter": "##"
                    }
                  },
                  {
                    "name": "GET_ELEMENT_AT_INDEX",
                    "params": {
                      "index": 3
                    }
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "LIST_VALUE_JOIN"
              }
            ],
            "required": true
          }
        ],
        "operations": [
          {
            "name": "KEY_VALUE_LIST_TO_OBJECT"
          }
        ]
      },
      "body": {
        "mappings": [
          {
            "key": "data",
            "value": "{{cardInfo.number}}",
            "required": true
          },
          {
            "key": "cvv",
            "value": "{{cardInfo.cvc}}",
            "required": true
          }
        ],
        "operations": [
          {
            "name": "KEY_VALUE_LIST_TO_OBJECT"
          }
        ]
      }
    },
    "responseMapping": {
      "body": {
        "mappings": [
          {
            "key": "status",
            "value": "{{pspResponse1.success}}",
            "operations": [
              {
                "name": "VALUE_MAPPER",
                "params": {
                  "mappings": [
                    {
                      "from": true,
                      "to": "payment_in_process"
                    },
                    {
                      "from": false,
                      "to": "payment_failed"
                    }
                  ],
                  "defaultValue": "payment_failed"
                }
              }
            ]
          },
          {
            "key": "code",
            "value": "{{pspResponse1.success}}",
            "operations": [
              {
                "name": "VALUE_MAPPER",
                "params": {
                  "mappings": [
                    {
                      "from": true,
                      "to": "success"
                    },
                    {
                      "from": false,
                      "to": "fail"
                    }
                  ],
                  "defaultValue": "fail"
                }
              }
            ]
          },
          {
            "key": "message",
            "mappings": [
              {
                "value": "{{pspResponse1.action}}"
              },
              {
                "value": "{{pspResponse1.title}}"
              },
              {
                "value": "{{pspResponse1.message}}"
              },
              {
                "value": "{{pspResponse1.error}}"
              },
              {
                "value": ""
              }
            ],
            "operations": [
              {
                "name": "GET_FIRST_NON_EMPTY_STRING"
              }
            ]
          },
          {
            "key": "tempObject",
            "mappings": [
              {
                "key": "token",
                "value": "{{pspResponse1.token}}"
              }
            ],
            "operations": [
              {
                "name": "KEY_VALUE_LIST_TO_OBJECT"
              }
            ]
          }
        ],
        "operations": [
          {
            "name": "KEY_VALUE_LIST_TO_OBJECT"
          }
        ]
      }
    }
  },
  {
    "requestMapping": {
      "method": "POST",
      "url": {
        "mappings": [
          {
            "value": "https://api-sandbox.coinflow.cash/api/auth/session-key",
            "required": true
          }
        ],
        "operations": [
          {
            "name": "LIST_VALUE_JOIN"
          }
        ]
      },
      "headers": {
        "mappings": [
          {
            "key": "Content-Type",
            "value": "application/json",
            "required": true
          },
          {
            "key": "Accept",
            "value": "application/json",
            "required": true
          },
          {
            "key": "Authorization",
            "mappings": [
              {
                "value": "{{bankTransaction.usedAuthKey}}",
                "required": true,
                "operations": [
                  {
                    "name": "SPLIT_STRING",
                    "params": {
                      "delimiter": "##"
                    }
                  },
                  {
                    "name": "GET_ELEMENT_AT_INDEX",
                    "params": {
                      "index": 0
                    }
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "LIST_VALUE_JOIN"
              }
            ],
            "required": true
          },
          {
            "key": "x-coinflow-auth-user-id",
            "value": "{{purchase.client.email}}",
            "required": true
          }
        ],
        "operations": [
          {
            "name": "KEY_VALUE_LIST_TO_OBJECT"
          }
        ]
      },
      "body": {
        "mappings": [
        ]
      }
    },
    "responseMapping": {
      "body": {
        "mappings": [
          {
            "key": "status",
            "value": "{{pspResponse2.key}}",
            "operations": [
              {
                "name": "CHECK_IF_NULL"
              },
              {
                "name": "VALUE_MAPPER",
                "params": {
                  "mappings": [
                    {
                      "from": false,
                      "to": "payment_in_process"
                    }
                  ],
                  "defaultValue": "fail"
                }
              }
            ]
          },
          {
            "key": "code",
            "value": "{{pspResponse2.key}}",
            "operations": [
              {
                "name": "CHECK_IF_NULL"
              },
              {
                "name": "VALUE_MAPPER",
                "params": {
                  "mappings": [
                    {
                      "from": false,
                      "to": "success"
                    }
                  ],
                  "defaultValue": "fail"
                }
              }
            ]
          },
          {
            "key": "message",
            "mappings": [
              {
                "value": "{{pspResponse2.action}}"
              },
              {
                "value": "{{pspResponse2.title}}"
              },
              {
                "value": "{{pspResponse2.message}}"
              },
              {
                "value": "{{pspResponse2.details}}"
              },
              {
                "value": ""
              }
            ],
            "operations": [
              {
                "name": "GET_FIRST_NON_EMPTY_STRING"
              }
            ]
          },
          {
            "key": "pspToken",
            "value": "{{pspResponse2.key}}"
          }
        ],
        "operations": [
          {
            "name": "KEY_VALUE_LIST_TO_OBJECT"
          }
        ]
      }
    }
  },
  {
    "requestMapping": {
      "method": "POST",
      "url": {
        "mappings": [
          {
            "value": "https://api-sandbox.coinflow.cash/api/checkout/card/paysecure",
            "required": true
          }
        ],
        "operations": [
          {
            "name": "LIST_VALUE_JOIN"
          }
        ]
      },
      "headers": {
        "mappings": [
          {
            "key": "Content-Type",
            "value": "application/json",
            "required": true
          },
          {
            "key": "Accept",
            "value": "application/json",
            "required": true
          },
          {
            "key": "x-coinflow-auth-session-key",
            "value": "{{bankTransaction.token}}",
            "required": true
          },
          {
            "key": "x-device-id",
            "value": "{{purchase.userDeviceId}}",
            "required": true
          }
        ],
        "operations": [
          {
            "name": "KEY_VALUE_LIST_TO_OBJECT"
          }
        ]
      },
      "body": {
        "mappings": [
          {
            "key": "subtotal",
            "mappings": [
              {
                "key": "cents",
                "mappings": [
                  {
                    "value": "{{purchase.fx_Amount}}",
                    "required": true,
                    "operations": [
                      {
                        "name": "STRING_TO_DOUBLE"
                      }
                    ]
                  },
                  {
                    "value": "100",
                    "required": true,
                    "operations": [
                      {
                        "name": "STRING_TO_DOUBLE"
                      }
                    ]
                  }
                ],
                "required": true,
                "operations": [
                  {
                    "name": "LIST_VALUE_MULTIPLY"
                  },
                  {
                    "name": "DOUBLE_TO_FLOOR"
                  },
                  {
                    "name": "INTEGER_TO_STRING"
                  }
                ]
              },
              {
                "key": "currency",
                "value": "{{purchase.fx_Currency}}",
                "required": true
              }
            ],
            "operations": [
              {
                "name": "KEY_VALUE_LIST_TO_OBJECT"
              }
            ],
            "required": true
          },
          {
            "key": "webhookInfo",
            "mappings": [
              {
                "key": "example",
                "mappings": [
                  {
                    "value": "{{extraParams.baseUrl}}",
                    "required": true
                  },
                  {
                    "value": "/webhook/",
                    "required": true
                  },
                  {
                    "value": "{{purchase.bankname}}",
                    "required": true
                  },
                  {
                    "value": "/",
                    "required": true
                  }
                ],
                "operations": [
                  {
                    "name": "LIST_VALUE_JOIN"
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "KEY_VALUE_LIST_TO_OBJECT"
              }
            ],
            "required": true
          },
          {
            "key": "threeDsChallengePreference",
            "value": "NoPreference",
            "required": true
          },
          {
            "key": "saveCard",
            "value": false
          },
          {
            "key": "card",
            "mappings": [
              {
                "key": "cardToken",
                "value": "{{pspResponse1.token}}",
                "required": true
              },
              {
                "key": "expYear",
                "value": "{{cardInfo.expireYear}}",
                "required": true
              },
              {
                "key": "expMonth",
                "value": "{{cardInfo.expireMonth}}",
                "required": true
              },
              {
                "key": "email",
                "value": "{{purchase.client.email}}",
                "required": true
              },
              {
                "key": "firstName",
                "mappings": [
                  {
                    "value": "{{purchase.client.full_name}}"
                  },
                  {
                    "value": "{{cardInfo.cardholder_name}}"
                  }
                ],
                "operations": [
                  {
                    "name": "GET_FIRST_NON_EMPTY_STRING"
                  },
                  {
                    "name": "SPLIT_STRING",
                    "params": {
                      "delimiter": "\\s+"
                    }
                  },
                  {
                    "name": "GET_ELEMENT_AT_INDEX",
                    "params": {
                      "index": 0
                    }
                  }
                ]
              },
              {
                "key": "lastName",
                "mappings": [
                  {
                    "value": "{{purchase.client.full_name}}"
                  },
                  {
                    "value": "{{cardInfo.cardholder_name}}"
                  }
                ],
                "operations": [
                  {
                    "name": "GET_FIRST_NON_EMPTY_STRING"
                  },
                  {
                    "name": "SPLIT_STRING",
                    "params": {
                      "delimiter": "\\s+"
                    }
                  },
                  {
                    "name": "GET_ELEMENT_AT_INDEX",
                    "params": {
                      "index": 0,
                      "fromLast": true
                    }
                  }
                ]
              },
              {
                "key": "address1",
                "value": "{{purchase.client.street_address}}",
                "required": true
              },
              {
                "key": "city",
                "value": "{{purchase.client.city}}",
                "required": true
              },
              {
                "key": "zip",
                "value": "{{purchase.client.zip_code}}",
                "required": true
              },
              {
                "key": "state",
                "value": "{{purchase.client.stateCode}}",
                "required": true
              },
              {
                "key": "country",
                "value": "{{purchase.client.country}}",
                "required": true
              }
            ],
            "operations": [
              {
                "name": "KEY_VALUE_LIST_TO_OBJECT"
              }
            ],
            "required": true
          },
          {
            "key": "authentication3DS",
            "mappings": [
              {
                "key": "colorDepth",
                "mappings": [
                  {
                    "value": "{{s2s.color_depth}}"
                  },
                  {
                    "value": 24
                  }
                ],
                "operations": [
                  {
                    "name": "GET_FIRST_NON_EMPTY_STRING"
                  }
                ],
                "required": true
              },
              {
                "key": "screenHeight",
                "mappings": [
                  {
                    "value": "{{s2s.screen_height}}"
                  },
                  {
                    "value": 1080
                  }
                ],
                "operations": [
                  {
                    "name": "GET_FIRST_NON_EMPTY_STRING"
                  }
                ],
                "required": true
              },
              {
                "key": "screenWidth",
                "mappings": [
                  {
                    "value": "{{s2s.screen_width}}"
                  },
                  {
                    "value": 1920
                  }
                ],
                "operations": [
                  {
                    "name": "GET_FIRST_NON_EMPTY_STRING"
                  }
                ],
                "required": true
              },
              {
                "key": "timeZone",
                "mappings": [
                  {
                    "value": "{{s2s.time_zone}}"
                  },
                  {
                    "value": -330
                  }
                ],
                "operations": [
                  {
                    "name": "GET_FIRST_NON_EMPTY_STRING"
                  }
                ],
                "required": true
              }
            ],
            "operations": [
              {
                "name": "KEY_VALUE_LIST_TO_OBJECT"
              }
            ],
            "required": true
          },
          {
            "key": "chargebackProtectionData",
            "mappings": [
              {
                "mappings": [
                  {
                    "key": "productName",
                    "value": "test product",
                    "required": true
                  },
                  {
                    "key": "productType",
                    "mappings": [
                      {
                        "value": "{{bankTransaction.usedAuthKey}}",
                        "required": true,
                        "operations": [
                          {
                            "name": "SPLIT_STRING",
                            "params": {
                              "delimiter": "##"
                            }
                          },
                          {
                            "name": "GET_ELEMENT_AT_INDEX",
                            "params": {
                              "index": 4
                            }
                          }
                        ]
                      }
                    ],
                    "operations": [
                      {
                        "name": "LIST_VALUE_JOIN"
                      }
                    ],
                    "required": true
                  },
                  {
                    "key": "quantity",
                    "value": "1",
                    "required": true,
                    "operations": [
                      {
                        "name": "STRING_TO_INTEGER"
                      }
                    ]
                  },
                  {
                    "key": "rawProductData",
                    "mappings": [
                      {
                        "key": "orderId",
                        "value": "{{purchase.purchaseId}}",
                        "required": true
                      }
                    ],
                    "required": true,
                    "operations": [
                      {
                        "name": "KEY_VALUE_LIST_TO_OBJECT"
                      }
                    ]
                  }
                ],
                "operations": [
                  {
                    "name": "KEY_VALUE_LIST_TO_OBJECT"
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "LIST_OBJECT_VALUE_TO_LIST_VALUE"
              }
            ]
          }
        ],
        "operations": [
          {
            "name": "KEY_VALUE_LIST_TO_OBJECT"
          }
        ],
        "required": true
      }
    },
    "responseMapping": {
      "body": {
        "mappings": [
          {
            "key": "pspTransactionId",
            "mappings": [
              {
                "value": "{{pspResponse3.paymentId}}"
              },
              {
                "value": "{{pspResponse3.transactionId}}"
              }
            ],
            "operations": [
              {
                "name": "GET_FIRST_NON_EMPTY_STRING"
              }
            ]
          },
          {
            "key": "code",
            "mappings": [
              {
                "value": "{{pspResponse3.paymentId}}",
                "operations": [
                  {
                    "name": "CHECK_IF_NULL"
                  },
                  {
                    "name": "VALUE_MAPPER",
                    "params": {
                      "mappings": [
                        {
                          "from": false,
                          "to": "success"
                        }
                      ]
                    }
                  }
                ]
              },
              {
                "value": "{{pspResponse3.transactionId}}",
                "operations": [
                  {
                    "name": "CHECK_IF_NULL"
                  },
                  {
                    "name": "VALUE_MAPPER",
                    "params": {
                      "mappings": [
                        {
                          "from": false,
                          "to": "success"
                        }
                      ]
                    }
                  }
                ]
              },
              {"value" : "error"}
            ],
            "operations": [
              {
                "name": "GET_FIRST_NON_EMPTY_STRING"
              }
            ]
          },
          {
            "key": "status",
            "mappings": [
              {
                "value": "{{pspResponse3.paymentId}}",
                "operations": [
                  {
                    "name": "CHECK_IF_NULL"
                  },
                  {
                    "name": "VALUE_MAPPER",
                    "params": {
                      "mappings": [
                        {
                          "from": false,
                          "to": "payment_in_process"
                        }
                      ]
                    }
                  }
                ]
              },
              {
                "value": "{{pspResponse3.transactionId}}",
                "operations": [
                  {
                    "name": "CHECK_IF_NULL"
                  },
                  {
                    "name": "VALUE_MAPPER",
                    "params": {
                      "mappings": [
                        {
                          "from": false,
                          "to": "payment_in_process"
                        }
                      ]
                    }
                  }
                ]
              },
              {"value" : "fail"}
            ],
            "operations": [
              {
                "name": "GET_FIRST_NON_EMPTY_STRING"
              }
            ]
          },
          {
            "key": "message",
            "mappings": [
              {
                "value": "{{pspResponse3.action}}"
              },
              {
                "value": "{{pspResponse3.title}}"
              },
              {
                "value": "{{pspResponse3.details}}"
              },
              {
                "value": "{{pspResponse3.message}}"
              },
              {
                "value": ""
              }
            ],
            "operations": [
              {
                "name": "GET_FIRST_NON_EMPTY_STRING"
              }
            ]
          },
          {
            "key": "url",
            "value": "{{pspResponse3.url}}",
            "operations": [
              {
                "name": "CHECK_IF_NULL"
              }
            ],
            "isHidden": true,
            "storeIn": "iframe"
          },
          {
            "key": "redirectUrl",
            "mappings": [
              {
                "key": "postUrl",
                "value": "{{pspResponse3.url}}"
              },
              {
                "key": "creq",
                "value": "{{pspResponse3.creq}}"
              },
              {
                "key": "returnUrl",
                "mappings": [
                  {
                    "value": "{{extraParams.baseUrl}}",
                    "required": true
                  },
                  {
                    "value": "/custRedirect/",
                    "required": true
                  },
                  {
                    "value": "{{purchase.bankid}}",
                    "required": true
                  },
                  {
                    "value": "/",
                    "required": true
                  },
                  {
                    "value": "{{purchase.purchaseId}}",
                    "required": true
                  },
                  {
                    "value": "/",
                    "required": true
                  }
                ],
                "operations": [
                  {
                    "name": "LIST_VALUE_JOIN"
                  }
                ]
              }
            ],
            "operations": [
              {
                "name": "GENERATE_HTML",
                "params": {
                  "htmlRenderMode": "IFRAME_SUBMISSION"
                }
              }
            ],
            "skipIf": "{{store.iframe.url}}"
          }
        ],
        "operations": [
          {
            "name": "KEY_VALUE_LIST_TO_OBJECT"
          }
        ]
      }
    }
  }
]